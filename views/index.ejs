<!doctype html>
<html>
<head>
<% if(locals.user){ %>
    <script src="/vendor/base.js"></script>
    <script src="/deps.js"></script>
    <script>
      goog.require('GameEngine');
    </script>

    <script src="/socket.io/socket.io.js"></script>
<% } %>
</head>
<body>
<% if(locals.user){ %>
    <!-- On doit faire passer le jeu par l'Ã©tat splash screen -->

    <p><%= user.fb.name.full %></p>

    <canvas id="canvas" width="800" height="600"></canvas>
    <script>
        var socket;
        var Game = new GameEngine();
        Game.init('canvas', function() {
            socket = io.connect('/');
            socket.on('connect', function (data) {
                var data = {
                    id: '<%= user.id %>',
                    fbId: '<%= user.fb.id %>',
                    fbName: '<%= user.fb.name.full %>'
                };
                socket.emit('player-init', data); 
            });

            socket.on('player-init', function(data){
                var x = data.x / Game.globalScale;
                var y = data.y /Game.globalScale; 
                Game.player = new game.Player({x: 30, y: 100});
                Game.bobetteManager.spawn({ownerId: data.id, x: data.slips.x, y: data.slips.y})

                // TODO: REMOVE THIS
                Game.playerManager.spawn({x: 100, y: 100, id: 'CALISS'});
                Game.bobetteManager.spawn({ownerId: 'CALISS', x: 100, y: 160})
            });

            socket.on('game-init', function(data){
                Game.player.id = '<%= user.id %>';

                socket.on('player-connected', function(data){
                    console.log('player-connected :: ', data);
                    Game.playerManager.spawn(data);
                    Game.bobetteManager.spawn({ownerId: data.id, x: data.slips.x, y: data.slips.y})
                });

                console.log('game-init :: ', data);

                for(var i =0; i< data.length; i++){
                   Game.playerManager.spawn(data[i]); 
                }

            });

            socket.on('player-update', function(data){
                Game.playerManager.updatePlayer(data);
            });

            socket.on('player-gameover', function(data){
                console.log('player-gameover :: ', data.id);
                for(var i=0; i< Game.playerManager.objs.length; i++){
                    if(Game.playerManager.objs[i].id == data.id){
                        Game.playerManager.objs.splice(i,1);
                        break;
                    }
                }
            });
        });
    </script>
<% }else { %>
    <h1>Splash Screen / Loading screen</h1>

    <!-- Pour l'instant..... on fera un change state plus tard -->
    <script>
        setTimeout(function(){
            window.location.href = '/login';
        }, 2000);
    </script>

<% } %>

</body>
</html>
